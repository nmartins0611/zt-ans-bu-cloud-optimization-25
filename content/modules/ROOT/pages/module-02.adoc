= Lab Guide: Retrieving Cloud Information with Job Templates
:toc:
:toc-title: Table of Contents
:sectnums:
:icons: font

This guide explains how to use a Job Template to retrieve information from a public cloud provider.

*Estimated time to complete: 20 minutes*

---

== Lab Overview

Welcome to the second challenge. In this lab, you will learn how to retrieve public cloud information with a job template in the automation controller.

First, log in to the Ansible Automation Platform UI with the following credentials.

.Login Credentials
[cols="1,2a"]
|===
| Username | `admin`
| Password | `ansible123!`
|===

---

== Task 1: Create a Job Template

To create a **Job Template**, you need three main components:

* An **inventory** to run the automation against.
* A **credential** to access the cloud provider's API.
* A **project** to synchronize your Ansible Playbooks from.

In this task, we will combine these components into a new job template.

. **Navigate to the Templates page.**
+
In the left navigation menu, select *Templates*.

. **Initiate the creation of a new job template.**
+
Click the **Create template** button, then select **Create job template**.
+
image::https://github.com/HichamMourad/awsinfravis25/blob/master/images/create_templates.png?raw=true[Create a new job template, 600, opts="border"]

. **Enter the job template details.**
+
Fill out the form with the following information:
+
[cols="1,1"]
|===
| Parameter | Value
| Name | `Retrieve VPC info`
| Job Type | `Run`
| Inventory | `Demo Inventory`
| Project | `AWS Demos Project`
| Execution Environment | `AWS Execution Environment`
| Playbook | `playbooks/info_vpcs.yml`
| Credentials | `AWS_Credential`
|===
+
TIP: When selecting the credential, you may need to filter by the `Amazon Web Services` credential type to find the `AWS_Credential`.

. **Save the job template.**
+
Click the blue **Save** button.

NOTE: The Ansible Playbooks for this lab are sourced from the following project: link:https://github.com/ansible-cloud/aws_demos[ansible-cloud/aws_demos].

---

== Task 2: Launch the Job Template

Now that the template is created, let's run it.

. **Navigate to the Templates page.**
+
If you are not already there, select *Templates* from the left navigation menu.

. **Launch the job template.**
+
Find the `Retrieve VPC info` job template in the list and click the **Launch** icon (üöÄ).
+
image::https://github.com/IPvSean/pictures_for_github/blob/master/launch_job.png?raw=true[Launch Job Icon, 80, opts="border"]

. **Examine the job output.**
+
This playbook runs two tasks:
+
* The first task, `amazon.aws.ec2_vpc_net_info`, retrieves structured data for all VPCs in the `us-east-1` region.
* The second task, `ansible.builtin.debug`, prints this data to the job output.
+
To view the data, click on the **Print vpc info to terminal** task. In the details pane that appears, select the **JSON** tab to see the structured data retrieved from AWS. We have pre-configured one VPC in this region.
+
image::https://github.com/HichamMourad/awsinfravis25/blob/master/images/vpc_output.png?raw=true[VPC structured data output, 400, opts="border"]
+
This structured data will be used in a future challenge to create dynamic documentation.

---

== Task 3: Create a Survey

Surveys allow you to prompt a user for information when a job template is launched, making your automation more interactive and flexible.

. **Open the job template's settings.**
+
Navigate back to the *Templates* page and click on the name of the `Retrieve VPC info` job template.

. **Navigate to the Survey tab.**
+
At the top of the template's details page, click the **Survey** tab.
+
image::https://github.com/IPvSean/pictures_for_github/blob/master/survey_tab.png?raw=true[Survey Tab, 400, opts="border"]

. **Create a new survey question.**
+
Click the blue **Add** button.

. **Configure the survey question.**
+
Fill out the form with the following values:
+
[cols="1,1"]
|===
| Parameter | Value
| Question | `What AWS region?`
| Description | `Choose the AWS region you want to query.`
| Answer variable name | `ec2_region`
| Answer type | `Multiple Choice (single select)`
| Required | Check the box ‚òëÔ∏è
| Multiple Choice Options | `us-east-1`, `us-east-2`, `eu-central-1`
|===

. **Set the default answer.**
+
Click the radio button next to `us-east-1` to make it the default option.

. **Save the survey question.**
+
Click the blue **Save** button.

. **Enable the survey.**
+
After saving, you must **enable the survey** by clicking the toggle switch at the top of the survey page.
+
image::https://github.com/HichamMourad/awsinfravis25/blob/master/images/survey_toggle.png?raw=true[Enable Survey Toggle, 600, opts="border"]

. **Launch the template again.**
+
Click the **Launch** button. This time, you will be prompted with the survey question you just created.
+
image::https://github.com/IPvSean/pictures_for_github/blob/master/what_region.png?raw=true[Survey Prompt, 200, opts="border"]
+
Feel free to choose a different region and verify that the output changes.

---

== Task 4: Create More Job Templates

You can create similar job templates to gather information about other AWS resources.

. **Create a job template to retrieve EC2 instance information.**
+
[cols="1,1"]
|===
| Parameter | Value
| Name | `Retrieve EC2 instances info`
| Playbook | `playbooks/info_instances.yml`
|===
+
NOTE: Use the same Inventory, Project, Execution Environment, and Credentials as the first template.

. **Create a job template to retrieve Internet Gateway (IGW) information.**
+
[cols="1,1"]
|===
| Parameter | Value
| Name | `Retrieve IGWs info`
| Playbook | `playbooks/info_igws.yml`
|===

. **(Optional) Create a combined information job template.**
+
This template combines information from VPCs, EC2 instances, and IGWs to provide a holistic view of your cloud infrastructure.
+
[cols="1,1"]
|===
| Parameter | Value
| Name | `Retrieve Combined info`
| Playbook | `playbooks/info_combined.yml`
|===
+
When you run this combined template, a cloud operator can quickly see how many instances are online in a given region, which VPCs they reside on, and their associated IGWs. This combined view helps identify unused resources, such as the retired VPCs shown in the example output below.
+
image::https://github.com/IPvSean/pictures_for_github/blob/master/cloud_awareness.png?raw=true[Combined cloud awareness output, opts="border"]

---

== Next Steps

You have successfully completed this lab. Press the `Check` button in the lab environment to proceed to the next challenge.

== Troubleshooting

If you have encountered an issue or have noticed something not quite right, please link:https://github.com/ansible/instruqt/issues/new?title=Issue+with+Ansible+Hybrid+Cloud+Automation+-+Infrastructure+visibility+(aap2.5)&assignees=hichammourad[open an issue on GitHub].
