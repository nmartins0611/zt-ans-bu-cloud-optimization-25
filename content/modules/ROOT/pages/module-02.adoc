:doctype: book
:toc:
:toc-title: Table of Contents
:sectnums:
:icons: font

= Lab Guide: Filtering Cloud Resources by Tags
_A guide to using filters and tags to control information retrieval from a public cloud._

*Estimated time to complete: 15 minutes*

---

== Lab Overview

Welcome to the second challenge in the Cloud Optimization lab. In this guide, you will learn how to use filters to control what information is retrieved from your cloud provider. One of the most common and powerful ways to filter resources is by using tags.

---

== Task 1: Log into Ansible Automation Platform

First, you will log in to the automation controller to begin the lab exercises.

. **Navigate to the Automation Controller UI.**
+
Click on the **Automation Controller** tab at the top of your lab window.

. **Log in with the provided credentials.**
+
[cols="1,2a"]
|===
| Parameter | Value
| Username | `admin`
| Password | `ansible123!`
|===

After logging in, you will land on the main dashboard.

---

== Task 2: Create a Job Template with a Filter

Next, you will create a job template that runs a playbook to retrieve specific EC2 instances based on a tag filter.

. **Navigate to the Templates page.**
+
In the left navigation menu, go to *Automation Execution* ‚Üí *Templates*.

. **Initiate the creation of a new job template.**
+
Click the **Create template** button, then select **Create job template**.
+
image::https://github.com/HichamMourad/awsoptimize25/blob/master/images/create_templates.png?raw=true[Create a new job template, 600, opts="border"]

. **Enter the job template details.**
+
Fill out the form with the following information:
+
[cols="1,1"]
|===
| Parameter | Value
| Name | `Retrieve INSTANCES by tag`
| Job Type | `Run`
| Inventory | `Demo Inventory`
| Project | `AWS Demos Project`
| Execution Environment | `AWS Execution Environment`
| Playbook | `playbooks/lab3-challenge2.yml`
| Credentials | `AWS_Credential`
|===
+
TIP: To find the `AWS_Credential`, you may need to filter the *Credential Type* to `Amazon Web Services`.

. **Save the job template.**
+
Scroll to the bottom and click the blue **Save** button.

NOTE: This playbook uses a default filter to find all instances where the `Name` tag starts with `rhel`. The filter is defined as an `extra_var` in the playbook.
+
[source,yaml]
----
filter_input:
  "tag:Name": "rhel*"
----

NOTE: The Ansible Playbooks for this lab are sourced from the following project: link:https://github.com/ansible-cloud/aws_demos[ansible-cloud/aws_demos].

---

== Task 3: Launch the Job Template

Now, you will run the template to see the default filter in action.

. **Launch the job template.**
+
Navigate back to the *Templates* page, find the `Retrieve INSTANCES by tag` job template, and click the **Launch** icon (üöÄ).
+
image::https://github.com/IPvSean/pictures_for_github/blob/master/launch_job.png?raw=true[Launch Job Icon, 80, opts="border"]

. **Understand the playbook execution.**
+
This playbook runs three main tasks:
+
* It uses the `amazon.aws.ec2_instance_info` module to find instances matching the `filter_input`.
+
[source,yaml]
----
- name: Retrieve info for the EC2 instances
  amazon.aws.ec2_instance_info:
    region: "{{ ec2_region }}"
    filters: "{{ filter_input }}"
  register: ec2_instance_info
----
+
* It uses the `debug` module and the `length` filter to count how many instances were found.
+
[source,yaml]
----
- name: Display how many instances match the filter
  debug:
    msg:
      - "There are {{ ec2_instance_info.instances | length }} instances that match your filter"
----
+
* It loops through the results and prints the `Name`, `instance_id`, and all `tags` for each instance.
+
[source,yaml]
----
- name: Display AWS EC2 info and tags information to terminal
  debug:
    msg:
      - "{{ item.tags['Name'] | default('The tag *Name* Does not exist') }}"
      - "{{ item.instance_id }}"
      - "{{ item.tags }}"
  loop: "{{ ec2_instance_info.instances }}"
----

. **Review the job output.**
+
The job output will show that two instances matched the default filter (`"tag:Name": "rhel*"`).
+
image::https://github.com/IPvSean/pictures_for_github/blob/master/job_output_optimization_challege2.png?raw=true[Job output showing two instances found, opts="border"]

---

== Task 4: Create a Survey to Control the Filter

To make the job template more flexible, you will add a survey that allows the user to specify a custom filter at launch time.

. **Open the job template's settings.**
+
Navigate back to the *Templates* page and click on the name of the `Retrieve INSTANCES by tag` job template.
+
image::https://github.com/IPvSean/pictures_for_github/blob/master/retrieve_instances_job.png?raw=true[Job template details page, 400, opts="border"]

. **Navigate to the Survey tab.**
+
At the top of the template's details page, click the **Survey** tab.

. **Create a new survey question.**
+
Click the blue **Add** button.

. **Configure the survey question.**
+
Fill out the survey form with the following values:
+
[cols="1,1"]
|===
| Parameter | Value
| Question | `Provide an EC2 filter`
| Description | `Provide the dictionary filter for AWS.`
| Answer variable name | `filter_input`
| Answer type | `Textarea`
| Required | Check the box ‚òëÔ∏è
|===

. **Save the survey question.**
+
Scroll to the bottom and click **Save**.

. **Enable the survey.**
+
You must **enable the survey** by clicking the toggle switch at the top of the survey page. The text will change from `SURVEY OFF` to `SURVEY ON`.
+
image::https://github.com/HichamMourad/awsoptimize25/blob/master/images/survey_toggle_short.png?raw=true[Enable Survey Toggle, 600, opts="border"]

. **Launch the template with a new filter.**
+
Click the **Launch** button. This time, a survey will prompt you for input. Enter the following text into the text area to find only the instance named `rhel1`:
+
[source,text]
----
"tag:Name": "rhel1"
----
+
Launch the job and observe that this time, only one instance is returned in the output.

TIP: Try launching the job again with some other tag combinations to see what is returned:
* `"tag:Index": "0"`
* `"tag:ansible-demo": "false"`
* `"tag:ansible-demo": "true"`
* `"tag:instruqt": "true"`

---

== Next Steps

You have successfully completed this lab. Press the `Check` button in your lab environment to proceed to the next challenge.

== Troubleshooting

If you have encountered an issue or have noticed something not quite right, please link:https://github.com/ansible/instruqt/issues/new?title=Issue+with+Ansible+Hybrid+Cloud+Automation+-+Infrastructure+optimization&assignees=hichammourad[open an issue on GitHub].
